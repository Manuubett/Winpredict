<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Soccer Prediction Tool</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        
        :root {
            --primary: #3498db;
            --secondary: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --dark-bg: #1a2a6c;
            --dark-card: rgba(30, 40, 70, 0.7);
            --dark-text: #fff;
            --light-bg: #f5f7fa;
            --light-card: rgba(255, 255, 255, 0.85);
            --light-text: #2c3e50;
            --header-gradient: linear-gradient(135deg, #1a2a6c, #2c3e50);
            --header-light: linear-gradient(135deg, #3498db, #2ecc71);
        }
        
        body.dark-mode {
            background: var(--dark-bg);
            color: var(--dark-text);
        }
        
        body.light-mode {
            background: var(--light-bg);
            color: var(--light-text);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 30px;
            border-bottom: 2px solid rgba(255,255,255,0.1);
            position: relative;
        }
        
        body.light-mode header {
            border-bottom: 2px solid rgba(0,0,0,0.1);
        }
        
        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(to right, #00b4db, #0083b0);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        body.light-mode header h1 {
            background: linear-gradient(to right, #1a2a6c, #3498db);
        }
        
        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.1);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: #fff;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
        
        body.light-mode .theme-toggle {
            background: rgba(0,0,0,0.05);
            color: #2c3e50;
        }
        
        .theme-toggle:hover {
            transform: rotate(15deg);
        }
        
        .card {
            background: var(--dark-card);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        body.light-mode .card {
            background: var(--light-card);
            border: 1px solid rgba(0,0,0,0.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .card h2 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            color: #4fc3f7;
            font-size: 1.8rem;
        }
        
        body.light-mode .card h2 {
            color: #1a2a6c;
        }
        
        .input-group {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .input-box {
            flex: 1;
            min-width: 200px;
        }
        
        .input-box label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            opacity: 0.9;
        }
        
        .input-box input, .input-box select {
            width: 100%;
            padding: 14px;
            border-radius: 10px;
            border: 2px solid #3498db;
            background: rgba(20, 30, 60, 0.7);
            color: white;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }
        
        body.light-mode .input-box input, 
        body.light-mode .input-box select {
            background: rgba(255, 255, 255, 0.9);
            color: #2c3e50;
            border: 2px solid #3498db;
        }
        
        .input-box input:focus, .input-box select:focus {
            border-color: #1abc9c;
            outline: none;
            box-shadow: 0 0 0 3px rgba(26, 188, 156, 0.3);
        }
        
        .btn {
            background: linear-gradient(45deg, #00c9ff, #92fe9d);
            color: #1a2a6c;
            border: none;
            padding: 14px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 20px auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }
        
        .result-card {
            background: rgba(25, 35, 75, 0.8);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }
        
        body.light-mode .result-card {
            background: rgba(255, 255, 255, 0.7);
        }
        
        .result-card:hover {
            transform: translateY(-5px);
        }
        
        .result-card h3 {
            color: #64ffda;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        body.light-mode .result-card h3 {
            color: #1a2a6c;
        }
        
        .suggestions ul {
            list-style: none;
        }
        
        .suggestions li {
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
        }
        
        body.light-mode .suggestions li {
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        .suggestions li:last-child {
            border-bottom: none;
            font-weight: bold;
            color: #64ffda;
            padding-top: 15px;
            margin-top: 10px;
            border-top: 1px solid rgba(100, 255, 218, 0.3);
        }
        
        body.light-mode .suggestions li:last-child {
            color: #1a2a6c;
            border-top: 1px solid rgba(26, 42, 108, 0.3);
        }
        
        .match-list {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .match-list ul {
            list-style: none;
        }
        
        .match-list li {
            padding: 12px 15px;
            margin-bottom: 10px;
            background: rgba(40, 50, 90, 0.6);
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        body.light-mode .match-list li {
            background: rgba(255, 255, 255, 0.7);
        }
        
        .match-list li b {
            color: #64ffda;
            flex: 1;
            min-width: 250px;
        }
        
        body.light-mode .match-list li b {
            color: #1a2a6c;
        }
        
        .match-list li small {
            opacity: 0.8;
            font-size: 0.9rem;
        }
        
        .search-box {
            margin-bottom: 20px;
            position: relative;
        }
        
        .search-box input {
            width: 100%;
            padding: 14px 14px 14px 45px;
            border-radius: 10px;
            border: 2px solid #3498db;
            background: rgba(20, 30, 60, 0.7);
            color: white;
            font-size: 1.1rem;
        }
        
        body.light-mode .search-box input {
            background: rgba(255, 255, 255, 0.9);
            color: #2c3e50;
        }
        
        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.7;
        }
        
        .feedback-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .feedback-btn {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: none;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .feedback-btn.right {
            background: linear-gradient(45deg, #00b09b, #96c93d);
            color: white;
        }
        
        .feedback-btn.wrong {
            background: linear-gradient(45deg, #ff416c, #ff4b2b);
            color: white;
        }
        
        .feedback-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .feedback-btn:active {
            transform: translateY(1px);
        }
        
        .toggle-btn {
            background: rgba(20, 30, 60, 0.7);
            color: white;
            border: 2px solid #3498db;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        
        body.light-mode .toggle-btn {
            background: rgba(255, 255, 255, 0.7);
            color: #2c3e50;
        }
        
        .toggle-btn:hover {
            background: rgba(30, 40, 80, 0.9);
        }
        
        body.light-mode .toggle-btn:hover {
            background: rgba(255, 255, 255, 0.9);
        }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            font-weight: 500;
        }
        
        .status.success {
            background: rgba(46, 204, 113, 0.2);
            border: 1px solid #2ecc71;
        }
        
        .status.error {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid #e74c3c;
        }
        
        .status.processing {
            background: rgba(52, 152, 219, 0.2);
            border: 1px solid #3498db;
        }
        
        .migration-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(45deg, #ff9966, #ff5e62);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 100;
            transition: all 0.3s ease;
        }
        
        .migration-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }
        
        /* Score frequency styles */
        .score-bar {
            margin: 10px 0;
        }
        
        .score-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .score-bar-bg {
            height: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            overflow: hidden;
        }
        
        body.light-mode .score-bar-bg {
            background: rgba(0,0,0,0.05);
        }
        
        .score-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #00c9ff, #92fe9d);
            border-radius: 10px;
        }
        
        @media (max-width: 768px) {
            .input-group {
                flex-direction: column;
            }
            
            .results-grid {
                grid-template-columns: 1fr;
            }
            
            header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body class="dark-mode">
    <div class="container">
        <header>
            <h1><i class="fas fa-futbol"></i> Virtual Soccer Prediction Engine</h1>
            <p>Advanced predictive analytics for soccer matches using historical odds data and Bayesian probability models</p>
            <div style="font-size: 0.9rem; color: yellow;">
  Subscription ends in <span id="timer">--:--:--</span>
</div>
            <button class="theme-toggle" onclick="toggleTheme()">
                <i class="fas fa-sun"></i>
            </button>
        </header>
        
        <div class="card">
            <h2><i class="fas fa-sliders-h"></i> Match Parameters</h2>
            <div class="input-group">
                <div class="input-box">
                    <label for="homeOdds"><i class="fas fa-home"></i> Home Odds</label>
                    <input id="homeOdds" type="number" step="0.01" placeholder="e.g. 2.10" value="2.10">
                </div>
                <div class="input-box">
                    <label for="drawOdds"><i class="fas fa-equals"></i> Draw Odds</label>
                    <input id="drawOdds" type="number" step="0.01" placeholder="e.g. 3.25" value="3.25">
                </div>
                <div class="input-box">
                    <label for="awayOdds"><i class="fas fa-car-side"></i> Away Odds</label>
                    <input id="awayOdds" type="number" step="0.01" placeholder="e.g. 3.80" value="3.80">
                </div>
                <div class="input-box">
                    <label for="riskProfile"><i class="fas fa-exclamation-triangle"></i> Risk Profile</label>
                    <select id="riskProfile">
                        <option value="safe">Safe</option>
                        <option value="moderate" selected>Moderate</option>
                        <option value="aggressive">Aggressive</option>
                    </select>
                </div>
            </div>
            <button class="btn" onclick="runPrediction()">
                <i class="fas fa-calculator"></i> Generate Predictions
            </button>
        </div>
        
        <div id="output" class="status"></div>
        
        <div class="card" id="suggestionsCard" style="display:none;">
            <h2><i class="fas fa-lightbulb"></i> Suggested Markets</h2>
            <div class="results-grid">
                <div class="result-card">
                    <h3><i class="fas fa-exchange-alt"></i> GG Market</h3>
                    <div id="ggMarket">-</div>
                </div>
                <div class="result-card">
                    <h3><i class="fas fa-chart-line"></i> Over/Under Markets</h3>
                    <div id="ouMarket">-</div>
                </div>
                <div class="result-card">
                    <h3><i class="fas fa-layer-group"></i> Double Chance</h3>
                    <div id="dcMarket">-</div>
                </div>
                <div class="result-card">
                    <h3><i class="fas fa-trophy"></i> Result Market</h3>
                    <div id="resultMarket">-</div>
                </div>
                <div class="result-card">
                    <h3><i class="fas fa-bullseye"></i> Goal Range</h3>
                    <div id="goalRange">-</div>
                </div>
                <div class="result-card">
                    <h3><i class="fas fa-flag-asia"></i> Asian Handicap</h3>
                    <div id="ahMarket">-</div>
                </div>
            </div>
            <div class="result-card" style="margin-top: 20px; background: rgba(40, 50, 90, 0.9);">
                <h3><i class="fas fa-star"></i> Overall Confidence</h3>
                <div id="confidenceScore" style="font-size: 1.5rem; font-weight: bold; text-align: center; color: #64ffda;">-</div>
            </div>
        </div>
        
        <div class="card" id="scoreFrequency" style="display:none;">
            <h2><i class="fas fa-chart-pie"></i> Score Frequency Analysis</h2>
            <div id="scoreFrequencyContent">
                <!-- Score bars will be generated here -->
            </div>
        </div>
        
        <div class="card" id="feedbackSection" style="display:none;">
            <h2><i class="fas fa-comment-dots"></i> Prediction Feedback</h2>
            <p>Was this prediction correct?</p>
            <div class="feedback-buttons">
                <button class="feedback-btn right" onclick="logFeedback('right')">
                    <i class="fas fa-check-circle"></i> ✅ Right
                </button>
                <button class="feedback-btn wrong" onclick="logFeedback('wrong')">
                    <i class="fas fa-times-circle"></i> ❌ Wrong
                </button>
            </div>
        </div>
        
        <div class="card">
            <h2><i class="fas fa-chart-bar"></i> Market Accuracy</h2>
            <button class="toggle-btn" onclick="toggleFeedback()">
                <i class="fas fa-sync-alt"></i> Show/Hide Feedback Stats
            </button>
            <div id="feedbackAccuracy" style="display: none;">
                <div class="result-card">
                    <div id="accuracyContent">Loading feedback stats...</div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2><i class="fas fa-clipboard-list"></i> Exact Match Records</h2>
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchTeam" placeholder="Search by team name..." oninput="filterMatchList()">
            </div>
            <div class="match-list">
                <ul id="matchList"></ul>
            </div>
        </div>
    </div>
    
    <button class="migration-btn" onclick="migrateTeamData()">
        <i class="fas fa-tools"></i> Fix Team Names
    </button>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script>
  const timerDisplay = document.getElementById("timer");
  const endTime = parseInt(localStorage.getItem("countdown_end_time"));

  if (!endTime || isNaN(endTime)) {
    window.location.href = "home 2.html";
  }

  function updateCountdown() {
    const now = Date.now();
    const remaining = endTime - now;

    if (remaining <= 0) {
      timerDisplay.textContent = "Expired";
      localStorage.removeItem("countdown_end_time");
      timerDisplay.style.background = "#333";
      timerDisplay.style.color = "#ff4444";
      timerDisplay.style.fontSize = "2.5rem";

      setTimeout(() => {
        window.location.href = "home 2.html";
      }, 2000);
    } else {
      const hours = Math.floor(remaining / (1000 * 60 * 60));
      const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
      timerDisplay.textContent = `${hours.toString().padStart(2, '0')}:${minutes
        .toString()
        .padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      requestAnimationFrame(updateCountdown);
    }
  }

  updateCountdown();
</script>
 
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDthFB2btT_r6slyX_xa5jeDOX8KDxsmdo",
            authDomain: "store-1d9e8.firebaseapp.com",
            projectId: "store-1d9e8",
            storageBucket: "store-1d9e8.appspot.com",
            messagingSenderId: "869478006120",
            appId: "1:869478006120:web:2045cbb98db8a3755e6add"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Global variables
        let lastPrediction = null;
        let currentExactMatches = [];
        
        // Risk-profile weighting schemes
        const riskWeights = {
            safe:      { GG: 0.15, Over_2_5: 0.15, DC_12: 0.45, Home_Win: 0.25 },
            moderate:  { GG: 0.25, Over_2_5: 0.25, DC_12: 0.25, Home_Win: 0.25 },
            aggressive:{ GG: 0.35, Over_2_5: 0.35, DC_12: 0.15, Home_Win: 0.15 }
        };
        
        // Toggle theme
        function toggleTheme() {
            const body = document.body;
            const themeToggle = document.querySelector('.theme-toggle i');
            
            if (body.classList.contains('dark-mode')) {
                body.classList.remove('dark-mode');
                body.classList.add('light-mode');
                themeToggle.classList.remove('fa-sun');
                themeToggle.classList.add('fa-moon');
            } else {
                body.classList.remove('light-mode');
                body.classList.add('dark-mode');
                themeToggle.classList.remove('fa-moon');
                themeToggle.classList.add('fa-sun');
            }
        }
        
        // Bayesian adjustment function
        function bayesianAdjust(rate, n, prior = 50, weight = 100) {
            return ((rate * n) + (prior * weight)) / (n + weight);
        }
        
        // Load cached matches from localStorage or Firestore
        async function loadCachedMatches() {
            const cached = localStorage.getItem('recentMatches');
            const lastFetch = localStorage.getItem('lastFetch');
            const now = Date.now();
            
            if (cached && lastFetch && now - lastFetch < 5 * 60 * 1000) {
                return JSON.parse(cached);
            }
            
            try {
                const snapshot = await db.collection("matches").orderBy("timestamp", "desc").get();
                const recent = snapshot.docs.map(doc => doc.data());
                
                localStorage.setItem('recentMatches', JSON.stringify(recent));
                localStorage.setItem('lastFetch', now);
                return recent;
            } catch (error) {
                console.error("Error loading match data:", error);
                document.getElementById('output').textContent = "❌ Failed to load match data. Please check your connection.";
                document.getElementById('output').className = "status error";
                return [];
            }
        }
        
        // Enhanced team name extraction
        function extractTeams(m = {}) {
            // Comprehensive field name checks
            const teamFields = [
                'homeTeam', 'awayTeam', 'home', 'away', 
                'teamA', 'teamB', 'team1', 'team2',
                'home_name', 'away_name', 'teams'
            ];
            
            // Check for direct team fields
            for (const field of teamFields) {
                if (m[field] && Array.isArray(m[field]) && m[field].length === 2) {
                    return m[field];
                }
            }
            
            // Try to parse from match string
            if (m.match && typeof m.match === 'string') {
                // Enhanced cleaning for various formats
                const cleaned = m.match
                    .replace(/\s+vs?\.?/gi, ' vs ')
                    .replace(/\s*[\(\{\[].*?[\)\}\]]\s*/g, '')  // Remove anything in brackets
                    .replace(/[^a-zA-Z0-9\s\-]/g, '')  // Remove special chars except hyphens
                    .replace(/\s{2,}/g, ' ')  // Collapse multiple spaces
                    .trim();
                
                // Split using multiple delimiters
                const teams = cleaned.split(/\s+vs\s+|\sv\s|\s-\s|\s@\s/i);
                
                if (teams.length === 2) {
                    return teams.map(t => t.trim());
                }
            }
            
            // Last resort - log and use fallback
            console.warn('Team name extraction failed for document:', m);
            return ['Team A', 'Team B'];
        }
        
        // Run prediction algorithm
        async function runPrediction() {
            // UI setup
            document.getElementById('output').textContent = '⏳ Calculating predictions... please wait.';
            document.getElementById('output').className = "status processing";
            document.getElementById('suggestionsCard').style.display = 'none';
            document.getElementById('feedbackSection').style.display = 'none';
            document.getElementById('scoreFrequency').style.display = 'none';
            
            // Get input values
            const home = parseFloat(document.getElementById('homeOdds').value);
            const draw = parseFloat(document.getElementById('drawOdds').value);
            const away = parseFloat(document.getElementById('awayOdds').value);
            
            // Validate inputs
            if (![home, draw, away].every(v => typeof v === 'number' && !isNaN(v) && v >= 1.01 && v <= 1000)) {
                document.getElementById('output').textContent = '❌ Please enter valid odds between 1.01 and 1000.';
                document.getElementById('output').className = "status error";
                return;
            }
            
            // Load matches
            const recentMatches = await loadCachedMatches();
            
            // Find exact matches
            const exactMatches = recentMatches.filter(m =>
                home.toFixed(2) === m.odds1?.toFixed(2) &&
                draw.toFixed(2) === m.oddsX?.toFixed(2) &&
                away.toFixed(2) === m.odds2?.toFixed(2)
            );
            
            // Handle no matches found
            if (exactMatches.length === 0) {
                document.getElementById('output').textContent = '❌ No exact match found in the database.';
                document.getElementById('output').className = "status error";
                return;
            }
            
            // Display matches and process data
            displayExactMatchList(exactMatches);
            
            const data = exactMatches;
            let totalW = 0, gg = 0, o25 = 0, o15 = 0, u35 = 0, dc1x = 0, dc12 = 0, dcx2 = 0;
            let homeW = 0, drawW = 0, awayW = 0, r01 = 0, r23 = 0, r4p = 0;
            let ah_home_win_by2 = 0, ah_draw = 0, ah_away_close = 0;
            const scores = {}, trends = {};
            
            // Process each match
            data.forEach(m => {
                const [a, b] = (m.result || '').split('-').map(Number);
                if (!isNaN(a) && !isNaN(b)) {
                    totalW += 1;
                    const goals = a + b;
                    const margin = a - b;
                    
                    // Goal-related stats
                    if (a > 0 && b > 0) gg++;
                    if (goals > 2.5) o25++;
                    if (goals > 1.5) o15++;
                    if (goals < 3.5) u35++;
                    
                    // Goal ranges
                    if (goals <= 1) r01++;
                    else if (goals <= 3) r23++;
                    else r4p++;
                    
                    // Asian handicap stats
                    if (margin >= 2) ah_home_win_by2++;
                    if (margin === 0) ah_draw++;
                    if (margin === 0 || margin === -1) ah_away_close++;
                    
                    // Double chance stats
                    if (a >= b) dc1x++;
                    if (a !== b) dc12++;
                    if (a <= b) dcx2++;
                    
                    // Win/loss stats
                    if (a > b) homeW++;
                    if (a === b) drawW++;
                    if (a < b) awayW++;
                    
                    // Score tracking
                    const score = `${a}-${b}`;
                    scores[score] = (scores[score] || 0) + 1;
                    trends[score] = (trends[score] || 0) + 1;
                }
            });
            
            // Bayesian adjustments
            const bayes = x => bayesianAdjust((x / totalW) * 100, totalW);
            const predictions = {
                GG: bayes(gg),
                Over_2_5: bayes(o25),
                Over_1_5: bayes(o15),
                Under_3_5: bayes(u35),
                DC_1X: bayes(dc1x),
                DC_12: bayes(dc12),
                DC_X2: bayes(dcx2),
                Home_Win: bayes(homeW),
                Draw: bayes(drawW),
                Away_Win: bayes(awayW),
                Range_0_1: bayes(r01),
                Range_2_3: bayes(r23),
                Range_4_plus: bayes(r4p),
                AH_HomeMinus1: bayes(ah_home_win_by2),
                AH_Draw: bayes(ah_draw),
                AH_AwayPlus1: bayes(ah_away_close)
            };
            
            // Apply risk profile weighting
            const profile = document.getElementById('riskProfile').value;
            const w = riskWeights[profile] || riskWeights.moderate;
            const biasBoost = {
                safe: 0.9,
                moderate: 1.0,
                aggressive: 1.1
            };
            
            predictions.GG *= biasBoost[profile];
            predictions.Over_2_5 *= biasBoost[profile];
            
            // Calculate confidence score
            const confidenceScore = 
                predictions.GG * w.GG +
                predictions.Over_2_5 * w.Over_2_5 +
                predictions.DC_12 * w.DC_12 +
                predictions.Home_Win * w.Home_Win;
            
            // Prepare suggestions
            const suggested = {
                best_GG_Market: `GG: ${predictions.GG.toFixed(1)}% | NO GG: ${(100 - predictions.GG).toFixed(1)}%`,
                best_OU_Market: `Over 1.5: ${predictions.Over_1_5.toFixed(1)}% | Over 2.5: ${predictions.Over_2_5.toFixed(1)}% | Under 3.5: ${predictions.Under_3_5.toFixed(1)}%`,
                best_DoubleChance: (() => {
                    const values = { 
                        '1X': predictions.DC_1X, 
                        '12': predictions.DC_12, 
                        'X2': predictions.DC_X2 
                    };
                    const best = Object.entries(values).sort((a, b) => b[1] - a[1])[0];
                    return `${best[0]} (${best[1].toFixed(1)}%)`;
                })(),
                best_Result: (() => {
                    const values = { 
                        'Home Win': predictions.Home_Win, 
                        'Draw': predictions.Draw, 
                        'Away Win': predictions.Away_Win 
                    };
                    const best = Object.entries(values).sort((a, b) => b[1] - a[1])[0];
                    return `${best[0]} (${best[1].toFixed(1)}%)`;
                })(),
                best_Goal_Range: (() => {
                    const values = {
                        '0–1 Goals': predictions.Range_0_1,
                        '2–3 Goals': predictions.Range_2_3,
                        '4+ Goals': predictions.Range_4_plus
                    };
                    const best = Object.entries(values).sort((a, b) => b[1] - a[1])[0];
                    return `${best[0]} (${best[1].toFixed(1)}%)`;
                })(),
                best_Asian_Handicap: (() => {
                    const values = {
                        'Home -1': predictions.AH_HomeMinus1,
                        'Draw (AHC)': predictions.AH_Draw,
                        'Away +1': predictions.AH_AwayPlus1
                    };
                    const best = Object.entries(values).sort((a, b) => b[1] - a[1])[0];
                    return `${best[0]} (${best[1].toFixed(1)}%)`;
                })(),
                confidenceScore: confidenceScore.toFixed(1) + '%'
            };
            
            // Update UI with results
            document.getElementById('ggMarket').textContent = suggested.best_GG_Market;
            document.getElementById('ouMarket').innerHTML = suggested.best_OU_Market.split(' | ').map(item => `<div>${item}</div>`).join('');
            document.getElementById('dcMarket').textContent = suggested.best_DoubleChance;
            document.getElementById('resultMarket').textContent = suggested.best_Result;
            document.getElementById('goalRange').textContent = suggested.best_Goal_Range;
            document.getElementById('ahMarket').textContent = suggested.best_Asian_Handicap;
            document.getElementById('confidenceScore').textContent = suggested.confidenceScore;
            
            document.getElementById('suggestionsCard').style.display = 'block';
            document.getElementById('feedbackSection').style.display = 'block';
            document.getElementById('scoreFrequency').style.display = 'block';
            
            document.getElementById('output').textContent = `✅ ${exactMatches.length} exact match(es) found and used for prediction.`;
            document.getElementById('output').className = "status success";
            
            // Display score frequencies
            displayScoreFrequencies(scores);
            
            // Store last prediction for feedback
            lastPrediction = { 
                odds_used: { home, draw, away }, 
                predictions,
                suggestions: suggested
            };
        }
        
        // Display score frequencies
        function displayScoreFrequencies(scores) {
            const scoreFreq = Object.entries(scores)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const total = scoreFreq.reduce((sum, [_, count]) => sum + count, 0);
            
            let html = '';
            scoreFreq.forEach(([score, count]) => {
                const percentage = ((count / total) * 100).toFixed(1);
                html += `
                    <div class="score-bar">
                        <div class="score-info">
                            <span>${score}</span>
                            <span>${count} times (${percentage}%)</span>
                        </div>
                        <div class="score-bar-bg">
                            <div class="score-bar-fill" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('scoreFrequencyContent').innerHTML = html;
        }
        
        // Display exact match list
        function displayExactMatchList(matches) {
            currentExactMatches = matches;
            const list = matches.map(m => {
                const [home, away] = extractTeams(m);
                const time = m.timestamp?.seconds ?
                    new Date(m.timestamp.seconds * 1000).toLocaleString() : '';
                return `
                    <li>
                        <b>${home} vs ${away}</b> — ${m.result || 'N/A'} 
                        <small>${time}</small>
                    </li>
                `;
            }).join('');
            document.getElementById('matchList').innerHTML = list;
        }
        
        // Filter match list
        function filterMatchList() {
            const q = document.getElementById('searchTeam').value.toLowerCase().trim();
            const filtered = currentExactMatches.filter(m => {
                const [home, away] = extractTeams(m).map(t => t.toLowerCase());
                return home.includes(q) || away.includes(q);
            });
            displayExactMatchList(filtered);
        }
        
        // Log feedback
        async function logFeedback(type) {
            if (!lastPrediction) return;
            
            // Disable buttons during submission
            document.querySelectorAll("#feedbackSection button").forEach(btn => {
                btn.disabled = true;
            });
            
            const payload = {
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                odds: lastPrediction.odds_used,
                prediction: lastPrediction.predictions,
                suggestions: lastPrediction.suggestions,
                feedback: type
            };
            
            try {
                await db.collection("feedback_logs").add(payload);
                document.getElementById('output').textContent = `✅ Feedback recorded: ${type}`;
                document.getElementById('output').className = "status success";
            } catch (error) {
                document.getElementById('output').textContent = "❌ Failed to record feedback";
                document.getElementById('output').className = "status error";
                console.error("Error logging feedback:", error);
            }
            
            // Hide feedback section after submission
            setTimeout(() => {
                document.getElementById('feedbackSection').style.display = 'none';
            }, 2000);
        }
        
        // Toggle feedback stats
        async function toggleFeedback() {
            const section = document.getElementById("feedbackAccuracy");
            if (section.style.display === "none") {
                section.style.display = "block";
                await loadFeedbackAccuracy();
            } else {
                section.style.display = "none";
            }
        }
        
        // Load feedback accuracy stats
        async function loadFeedbackAccuracy() {
            document.getElementById('accuracyContent').textContent = "Loading feedback stats...";
            
            try {
                const snap = await db.collection("feedback_logs").get();
                const marketStats = {};
                
                snap.forEach(doc => {
                    const data = doc.data();
                    const suggestions = data.suggestions || {};
                    const verdict = data.feedback;
                    
                    if (suggestions.best_GG_Market) {
                        const label = suggestions.best_GG_Market;
                        if (!marketStats[label]) marketStats[label] = { right: 0, wrong: 0 };
                        marketStats[label][verdict === "right" ? "right" : "wrong"]++;
                    }
                });
                
                const statsArray = Object.entries(marketStats).map(([market, result]) => {
                    const total = result.right + result.wrong;
                    const accuracy = total > 0 ? ((result.right / total) * 100).toFixed(1) : "0.0";
                    return { market, ...result, total, accuracy };
                }).sort((a, b) => b.accuracy - a.accuracy);
                
                const html = statsArray.map(m => `
                    <div style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <b>${m.market}</b>
                        <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                            <span>✅ ${m.right} right</span>
                            <span>❌ ${m.wrong} wrong</span>
                        </div>
                        <div style="margin-top: 8px; background: rgba(255,255,255,0.1); border-radius: 5px; overflow: hidden;">
                            <div style="width: ${m.accuracy}%; background: ${m.accuracy > 70 ? '#2ecc71' : m.accuracy > 50 ? '#f1c40f' : '#e74c3c'}; 
                                 height: 8px;"></div>
                        </div>
                        <div style="text-align: center; margin-top: 5px; font-weight: bold; color: #64ffda;">
                            ${m.accuracy}% Accuracy
                        </div>
                    </div>
                `).join("");
                
                document.getElementById("accuracyContent").innerHTML = html;
            } catch (error) {
                document.getElementById('accuracyContent').textContent = "❌ Failed to load feedback stats";
                console.error("Error loading feedback stats:", error);
            }
        }
        
        // Migrate team data
        async function migrateTeamData() {
            const btn = document.querySelector('.migration-btn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Fixing Team Names...';
            btn.disabled = true;
            
            try {
                const snapshot = await db.collection("matches").get();
                const batch = db.batch();
                let count = 0;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const [home, away] = extractTeams(data);
                    
                    // Only update if we found better names
                    if (!home.includes('Team A') || !away.includes('Team B')) {
                        batch.update(doc.ref, {
                            homeTeam: home,
                            awayTeam: away
                        });
                        count++;
                    }
                });
                
                await batch.commit();
                document.getElementById('output').textContent = `✅ Team names updated for ${count} documents`;
                document.getElementById('output').className = "status success";
                
                // Clear cache to force reload
                localStorage.removeItem('recentMatches');
                localStorage.removeItem('lastFetch');
                
                // Reload data
                await runPrediction();
            } catch (error) {
                document.getElementById('output').textContent = "❌ Migration failed. Check console for details.";
                document.getElementById('output').className = "status error";
                console.error("Migration failed:", error);
            }
            
            btn.innerHTML = '<i class="fas fa-check"></i> Team Names Fixed!';
            setTimeout(() => {
                btn.innerHTML = '<i class="fas fa-tools"></i> Fix Team Names';
                btn.disabled = false;
            }, 3000);
        }
        
        // Initialize on load
        window.onload = function() {
            // Set sample data for demo
            document.getElementById('homeOdds').value = "2.10";
            document.getElementById('drawOdds').value = "3.25";
            document.getElementById('awayOdds').value = "3.80";
            
            // Load feedback accuracy
            loadFeedbackAccuracy();
        };
    </script>
</body>
</html>
