<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payment Verification - WinPredict</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
   <link rel="stylesheet" href="verify.css">
</head>
<body>
  <div class="container container-main">
    <!-- Logo Header -->
    <div class="logo-header">
      <a href="https://manuubett.github.io/Winpredict/" class="logo">
        <i class="fas fa-chart-line logo-icon"></i>
        <span class="logo-text">WinPredict</span>
      </a>
    </div>
    
    <div class="row justify-content-center">
      <div class="col-12">
        <div class="card">
          <div class="payment-header">
            <h2>Payment Verification</h2>
            <p>One-time payment for maintenance and services to keep clients in touch</p>
          </div>
          <div class="card-body">
            <!-- Step 1: Payment Details -->
            <div class="step-container">
              <div class="step-icon">1</div>
              <div class="step-content">
                <h5>Complete Payment</h5>
                <p>Send payment via M-PESA using the details below</p>
              </div>
            </div>
            
            <div class="payment-details">
              <div class="row">
                <div class="col-md-4 mb-3">
                  <div class="detail-item">
                    <div class="detail-label">Amount</div>
                    <div class="detail-value">
                      <i class="fas fa-money-bill-wave"></i>
                      Ksh 25.00
                    </div>
                  </div>
                </div>
                <div class="col-md-4 mb-3">
                  <div class="detail-item">
                    <div class="detail-label">Paybill Number</div>
                    <div class="detail-value">
                      <i class="fas fa-building"></i>
                      4585402
                    </div>
                  </div>
                </div>
                <div class="col-md-4 mb-3">
                  <div class="detail-item">
                    <div class="detail-label">Account Name</div>
                    <div class="detail-value">
                      <i class="fas fa-user"></i>
                      
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="payment-info-box">
                <i class="fas fa-info-circle"></i>
                <p class="mb-0">This is a <strong>one-time payment</strong> for maintenance and services to keep our clients in touch with our platform.</p>
              </div>
            </div>
            
            <!-- Step 2: Verification -->
            <div class="step-container step-active">
              <div class="step-icon">2</div>
              <div class="step-content">
                <h5>Verify Payment</h5>
                <p>Submit your M-PESA confirmation message for verification</p>
              </div>
            </div>
            
            <div class="mb-4">
              <p>Paste your full M-PESA confirmation message below. It should look like this:</p>
              <div class="example-block">
                TEI6763XKM Confirmed. Ksh25.00 paid to... on 17/6/25 at 14:30 PM New M-PESA balance is Ksh2,450.00.
              </div>
            </div>
            
            <div id="verification-form">
              <div class="mb-4">
                <label for="mpesa-message" class="form-label fw-bold">M-PESA Confirmation Message</label>
                <textarea class="form-control" id="mpesa-message" placeholder="Paste your complete M-PESA message here..."></textarea>
              </div>
              <button class="btn btn-primary" onclick="submitMessage()">
                <i class="fas fa-paper-plane me-2"></i>Submit for Verification
              </button>
            </div>
            
            <div id="success-message" class="hidden success-alert">
              <div class="d-flex align-items-center">
                <i class="fas fa-check-circle fa-2x me-3" style="color: #28a745;"></i>
                <div>
                  <h5 class="mb-1">Verification Submitted!</h5>
                  <p class="mb-0">✅ Your payment details have been received. You'll be verified shortly and redirected automatically.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Verification Process Steps -->
        <div class="card">
          <div class="card-body">
            <h4 class="mb-4 text-center" style="color: var(--primary-dark);">Verification Process</h4>
            <div class="verification-steps">
              <div class="row">
                <div class="col-md-4 mb-4 mb-md-0">
                  <div class="step-card">
                    <div class="step-icon-small">1</div>
                    <h6>Submit Confirmation</h6>
                    <p>Paste your complete M-PESA message in the field above</p>
                  </div>
                </div>
                
                <div class="col-md-4 mb-4 mb-md-0">
                  <div class="step-card">
                    <div class="step-icon-small">2</div>
                    <h6>Automated Verification</h6>
                    <p>Our system will validate your payment details</p>
                  </div>
                </div>
                
                <div class="col-md-4">
                  <div class="step-card">
                    <div class="step-icon-small">3</div>
                    <h6>Access Granted</h6>
                    <p>Once verified, you'll be redirected automatically</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Footer -->
    <div class="footer">
      <p>© 2023 WinPredict. All rights reserved. | This is a one-time payment for maintenance and services</p>
      <p>Need help? <a href="https://wa.me/254704518130"><i class="fab fa-whatsapp me-1"></i>Contact Support</a></p>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBTmeDxIUhua52KDAoag23q9MuNEOQXYQg",
      authDomain: "prediction-94bf9.firebaseapp.com",
      databaseURL: "https://prediction-94bf9-default-rtdb.firebaseio.com",
      projectId: "prediction-94bf9",
      storageBucket: "prediction-94bf9.appspot.com",
      messagingSenderId: "960123689722",
      appId: "1:960123689722:web:ca9579625439ecf2478743",
      measurementId: "G-MTDJTB6JXG"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let userId = localStorage.getItem('user_id');

    // Already submitted? Check if verified
    if (userId) {
      document.getElementById('success-message').classList.remove('hidden');
      checkVerificationStatus(userId);
    } else {
      document.getElementById('verification-form').style.display = 'block';
    }

    function isValidMessage(msg) {
      const hasCode = /^[A-Z0-9]{10}/.test(msg);
      const hasAmount = /Ksh\s?25\.00/.test(msg);
      const hasName = /Emanuel Kipkirui Bett/.test(msg);
      return hasCode && hasAmount && hasName;
    }

    function submitMessage() {
      const message = document.getElementById('mpesa-message').value.trim();

      if (!isValidMessage(message)) {
        alert("❌ Invalid message. Please ensure it's a full M-PESA confirmation for Ksh25.00 to Emanuel Kipkirui Bett.");
        return;
      }

      userId = Date.now().toString();
      localStorage.setItem('user_id', userId);

      const payload = {
        message: message,
        timestamp: new Date().toISOString(),
        verified: false
      };

      console.log("Submitting message to Firebase:", payload);

      db.ref("submissions/" + userId).set(payload)
        .then(() => {
          const phoneNumber = "254704518130";
          const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent("M-PESA Confirmation:\n" + message)}`;
          window.open(whatsappUrl, '_blank');

          document.getElementById('verification-form').style.display = 'none';
          document.getElementById('success-message').classList.remove('hidden');

          checkVerificationStatus(userId);
        })
        .catch(error => {
          alert("❌ Error submitting to Firebase. Check console for details.");
          console.error("Firebase error:", error);
        });
    }

    function checkVerificationStatus(id) {
      const ref = db.ref("submissions/" + id + "/verified");

      ref.on("value", (snapshot) => {
        const verified = snapshot.val();
        console.log("Verification status:", verified);

        if (verified === true) {
          localStorage.setItem('payment_verified', 'true');
          window.location.href = "main.html";
        }
      });
    }
  </script>
  
  <!-- Bootstrap Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
                  </html>
