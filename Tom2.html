<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced Football Match Predictor</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #1a2a6c, #2a5298);
      color: #333;
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    header {
      text-align: center;
      padding: 30px 0;
      color: white;
      position: relative;
      margin-bottom: 30px;
    }
    
    header::after {
      content: "";
      display: block;
      height: 4px;
      width: 100px;
      background: #FFD700;
      margin: 15px auto;
      border-radius: 2px;
    }
    
    header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    header p {
      font-size: 1.1rem;
      max-width: 700px;
      margin: 0 auto;
      color: rgba(255,255,255,0.85);
    }
    
    .app-container {
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      overflow: hidden;
    }
    
    .app-header {
      background: #0c1e45;
      color: white;
      padding: 15px 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .stats {
      display: flex;
      gap: 20px;
      font-size: 0.9rem;
    }
    
    .stat-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .stat-value {
      font-weight: bold;
      background: #FFD700;
      color: #0c1e45;
      padding: 2px 8px;
      border-radius: 10px;
    }
    
    .main-content {
      display: flex;
      flex-wrap: wrap;
      padding: 25px;
      gap: 25px;
    }
    
    .panel {
      background: #f8f9fa;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      padding: 25px;
      flex: 1;
      min-width: 300px;
    }
    
    .panel-title {
      font-size: 1.3rem;
      margin-bottom: 20px;
      color: #0c1e45;
      display: flex;
      align-items: center;
      gap: 10px;
      padding-bottom: 10px;
      border-bottom: 2px solid #eaeaea;
    }
    
    textarea {
      width: 100%;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      resize: vertical;
      min-height: 150px;
      transition: border-color 0.3s;
    }
    
    textarea:focus {
      outline: none;
      border-color: #2a5298;
    }
    
    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 15px;
    }
    
    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: #2a5298;
      color: white;
    }
    
    .btn-success {
      background: #28a745;
      color: white;
    }
    
    .btn-warning {
      background: #ffc107;
      color: #333;
    }
    
    .btn-danger {
      background: #dc3545;
      color: white;
    }
    
    .btn-info {
      background: #17a2b8;
      color: white;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .select-group {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin: 20px 0;
    }
    
    select {
      flex: 1;
      min-width: 200px;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
    }
    
    .result-container {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-top: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      max-height: 600px;
      overflow-y: auto;
    }
    
    .result-title {
      font-size: 1.4rem;
      color: #0c1e45;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .safe-match {
      background: #e6f7e6;
      padding: 15px;
      margin: 15px 0;
      border-radius: 8px;
      border-left: 4px solid #28a745;
    }
    
    .pattern-badge {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: bold;
      background: #28a745;
      color: white;
      margin-left: 10px;
    }
    
    .match-detail {
      margin-top: 10px;
      padding: 10px;
      background: rgba(255,255,255,0.7);
      border-radius: 6px;
      font-size: 0.9rem;
    }
    
    .prediction-section {
      margin: 20px 0;
      padding: 15px;
      background: #f0f8ff;
      border-radius: 8px;
    }
    
    .prediction-header {
      font-size: 1.2rem;
      color: #0c1e45;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .prediction-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .prediction-card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      border-top: 4px solid #2a5298;
    }
    
    .card-title {
      font-size: 1.1rem;
      margin-bottom: 15px;
      color: #0c1e45;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .prediction-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }
    
    .confidence {
      font-weight: bold;
    }
    
    .high-confidence {
      color: #28a745;
    }
    
    .medium-confidence {
      color: #ffc107;
    }
    
    .low-confidence {
      color: #dc3545;
    }
    
    .recommendation {
      background: #fff8e1;
      border-left: 4px solid #ffc107;
      padding: 15px;
      margin-top: 20px;
      border-radius: 0 8px 8px 0;
    }
    
    .recommendation-title {
      font-size: 1.2rem;
      margin-bottom: 10px;
      color: #0c1e45;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .recommendation-list {
      padding-left: 20px;
    }
    
    .recommendation-list li {
      margin-bottom: 8px;
    }
    
    .footer {
      text-align: center;
      color: white;
      padding: 30px 0;
      margin-top: 30px;
      font-size: 0.9rem;
      opacity: 0.8;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .main-content {
        flex-direction: column;
      }
      
      .panel {
        width: 100%;
      }
      
      header h1 {
        font-size: 2rem;
      }
    }
    
    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #2a5298;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #1a2a6c;
    }
    
    /* Loading animation */
    .loader {
      display: none;
      text-align: center;
      padding: 20px;
    }
    
    .loader .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-left-color: #2a5298;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1><i class="fas fa-futbol"></i> Advanced Football Match Predictor</h1>
      <p>Predict match outcomes, analyze team performance, and identify betting opportunities with advanced statistical models</p>
    </header>
    
    <div class="app-container">
      <div class="app-header">
        <h2><i class="fas fa-tachometer-alt"></i> Prediction Dashboard</h2>
        <div class="stats">
          <div class="stat-item">
            <i class="fas fa-database"></i>
            <span>Matches Analyzed: <span class="stat-value" id="matchCount">0</span></span>
          </div>
          <div class="stat-item">
            <i class="fas fa-chart-line"></i>
            <span>Accuracy: <span class="stat-value">78.3%</span></span>
          </div>
          <div class="stat-item">
            <i class="fas fa-bolt"></i>
            <span>Current Streak: <span class="stat-value">W5</span></span>
          </div>
        </div>
      </div>
      <div id="countdown" style="text-align:center; font-size: 1.5em; color: green;"></div>
      <div class="main-content">
        <div class="panel">
          <h3 class="panel-title"><i class="fas fa-upload"></i> Input Match Data</h3>
          <textarea id="resultsInput" placeholder="Paste match results (4 lines per match):
Team A
2
1
Team B
Team C
0
3
Team D"></textarea>
          
          <div class="btn-group">
            <button class="btn btn-primary" onclick="addToStorage()">
              <i class="fas fa-plus-circle"></i> Add Results
            </button>
            <button class="btn btn-danger" onclick="clearStorage()">
              <i class="fas fa-trash-alt"></i> Clear Data
            </button>
            <button class="btn btn-info" onclick="downloadData()">
              <i class="fas fa-download"></i> Download Data
            </button>
          </div>
          <!-- Add this button near the top of your HTML (after the header but before the app-container) -->
<div style="text-align: center; margin: 20px 0;">
  <button class="btn btn-danger" onclick="showTutorial()" style="background: #FF0000; border: none; padding: 12px 25px; font-size: 1.1rem;">
    <i class="fab fa-youtube"></i> Watch Quick Tutorial
  </button>
</div><div id="expiredModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999; justify-content:center; align-items:center;">
  <div style="background:#fff; padding:30px; max-width:320px; text-align:center; border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,0.3);">
    <h3 style="color:#e53935;">Subscription Expired</h3>
    <p style="margin:15px 0;">Your access has ended.<br>Please subscribe again to continue.</p>
    <button onclick="redirectToSubscribe()" style="padding:10px 20px; background:#4caf50; color:#fff; border:none; border-radius:5px; font-weight:bold;">Subscribe Again</button>
  </div>
</div>


<script>
  function startCountdown(endTime) {
    const countdownEl = document.getElementById('countdown');

    const interval = setInterval(() => {
      const now = Date.now();
      const remaining = endTime - now;

      if (remaining <= 0) {
        clearInterval(interval);
        countdownEl.innerText = "Subscription expired.";
        showExpiryPopup(); // 👈 Show the modern popup instead of alert
        return;
      }

      const hrs = Math.floor(remaining / (1000 * 60 * 60));
      const mins = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
      const secs = Math.floor((remaining % (1000 * 60)) / 1000);

      countdownEl.innerText = `Time Left: ${pad(hrs)}:${pad(mins)}:${pad(secs)}`;
    }, 1000);
  }

  function pad(num) {
    return num.toString().padStart(2, '0');
  }

  function showExpiryPopup() {
    const modal = document.getElementById('expiredModal');
    modal.style.display = 'flex';

    // Clear localStorage
    const phone = localStorage.getItem('sub_phone');
    if (phone) localStorage.removeItem('sub_timer_' + phone);
    localStorage.removeItem('sub_phone');
    localStorage.removeItem('sub_duration');
  }

  function redirectToSubscribe() {
    window.location.href = "Subscription 2.html";
  }

  // Run on page load
  window.addEventListener('DOMContentLoaded', () => {
    const phone = localStorage.getItem('sub_phone');
    const end = localStorage.getItem('sub_timer_' + phone);

    if (!phone || !end) {
      showExpiryPopup(); // 👈 Use popup if data is missing
    } else if (Date.now() < Number(end)) {
      startCountdown(Number(end));
    } else {
      showExpiryPopup(); // 👈 Use popup if expired
    }
  });
</script>

<!-- Add this modal at the bottom of your HTML (before the closing body tag) -->
<div id="tutorialModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
  <div style="background: white; padding: 25px; border-radius: 10px; max-width: 400px; width: 90%; max-height: 90vh; overflow-y: auto; position: relative;">
    <button onclick="closeTutorial()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 20px; cursor: pointer; color: #FF0000;">×</button>
    <h2 style="color: #FF0000; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
      <i class="fab fa-youtube"></i> How to Use Predictor
    </h2>
    
    <!-- YouTube Shorts Embed -->
    <div style="position: relative; padding-bottom: 177.78%; height: 0; overflow: hidden; margin-bottom: 20px; border-radius: 8px; overflow: hidden;">
      <iframe id="youtubeVideo" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none;" 
              src="" 
              frameborder="0" 
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
              allowfullscreen></iframe>
    </div>
    
    <div style="background: #FFF8E1; padding: 15px; border-radius: 8px; border-left: 4px solid #FFD700; margin-top: 20px;">
      <h3 style="margin-bottom: 10px; display: flex; align-items: center; gap: 8px; color: #333;">
        <i class="fas fa-bell" style="color: #FF0000;"></i> Get More Predictions
      </h3>
      <p style="margin-bottom: 15px; line-height: 1.5;">Subscribe to <strong>@candle-o1p</strong> for weekly football predictions and exclusive tips!</p>
      <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; justify-content: center;">
        <a href="https://www.youtube.com/@candle-o1p?sub_confirmation=1" 
           target="_blank" 
           class="btn" 
           style="background: #FF0000; color: white; text-decoration: none; padding: 10px 20px; border-radius: 8px; font-weight: 600;">
          <i class="fab fa-youtube"></i> Subscribe Now
        </a>
        <button onclick="closeTutorial()" class="btn btn-warning" style="padding: 10px 20px;">
          Maybe Later
        </button>
      </div>
      <p style="margin-top: 15px; font-size: 0.9em; color: #666; text-align: center;">
        <i class="fas fa-lock" style="margin-right: 5px;"></i> We never spam or share your data
      </p>
    </div>
  </div>
</div>
<!-- ✅ Add this inside <body> of Tom2.html -->
<div id="expiredModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999; justify-content:center; align-items:center;">
  <div style="background:#fff; padding:30px; max-width:320px; text-align:center; border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,0.3);">
    <h3 style="color:#e53935;">Subscription Expired</h3>
    <p style="margin:15px 0;">Your access has ended.<br>Please subscribe again to continue.</p>
    <button onclick="redirectToSubscribe()" style="padding:10px 20px; background:#4caf50; color:#fff; border:none; border-radius:5px; font-weight:bold;">Subscribe Again</button>
  </div>
</div>



<script>
  // YouTube Tutorial Functions
  function showTutorial() {
    const modal = document.getElementById('tutorialModal');
    const iframe = document.getElementById('youtubeVideo');
    
    // Using your YouTube Shorts link (converted to embed format)
    iframe.src = "https://www.youtube.com/embed/qO7slkz169c?autoplay=1&si=u2KuMSGTE_3N_iLF";
    
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    
    // Track tutorial views (optional)
    localStorage.setItem('lastTutorialView', new Date().toISOString());
  }

  function closeTutorial() {
    const modal = document.getElementById('tutorialModal');
    const iframe = document.getElementById('youtubeVideo');
    
    iframe.src = "";
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
  }

  // Show tutorial on first visit or once per week
  document.addEventListener('DOMContentLoaded', function() {
    const lastView = localStorage.getItem('lastTutorialView');
    const oneWeekAgo = new Date();
    oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
    
    if(!lastView || new Date(lastView) < oneWeekAgo) {
      setTimeout(showTutorial, 2000); // Show after 2 seconds
    }
  });
</script>
          
          <input type="file" id="fileUpload" style="display: none" onchange="uploadData(event)">
          <button class="btn btn-warning" style="margin-top: 12px;" onclick="document.getElementById('fileUpload').click()">
            <i class="fas fa-file-upload"></i> Upload Match Data
          </button>
          
          <h3 class="panel-title" style="margin-top: 30px;"><i class="fas fa-search"></i> Team Analysis</h3>
          <div class="select-group">
            <select id="team1">
              <option value="">Select Team 1</option>
            </select>
            <select id="team2">
              <option value="">Select Team 2</option>
            </select>
          </div>
          <button class="btn btn-success" onclick="showSmartPrediction()">
            <i class="fas fa-chart-bar"></i> Analyze Matchup
          </button>
        </div>
        
        <div class="panel">
          <h3 class="panel-title"><i class="fas fa-shield-alt"></i> Safe Matches</h3>
          <p>Identify matches with consistent patterns for safer betting opportunities:</p>
          
          <button class="btn btn-info" onclick="displaySafeMatches()">
            <i class="fas fa-search"></i> Find Safe Matches
          </button>
          
          <div class="loader" id="safeMatchesLoader">
            <div class="spinner"></div>
            <p>Analyzing match patterns...</p>
          </div>
          
          <div class="result-container" id="safeMatchesOutput">
            <!-- Safe matches will be displayed here -->
          </div>
        </div>
      </div>
      
      <div class="panel" style="margin: 0 25px 25px;">
        <h3 class="panel-title"><i class="fas fa-chart-pie"></i> Match Prediction Analysis</h3>
        <div class="result-container" id="output">
          <!-- Prediction results will be displayed here -->
        </div>
      </div>
    </div>
    
    <div class="footer">
      <p>Advanced Football Match Predictor © 2023 | Using advanced statistical models and machine learning</p>
      <p>Disclaimer: Predictions are based on historical data and statistical models. No guarantee of accuracy.</p>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'match_results';
    const ELO_KEY = 'team_elo_ratings';
    let eloRatings = JSON.parse(localStorage.getItem(ELO_KEY)) || {};
    
    // Initialize the app
    document.addEventListener('DOMContentLoaded', function() {
      loadTeams();
      showMatchCount();
    });

    function parseInput(rawText) {
      const lines = rawText.trim().split('\n');
      const parsed = [];
      for (let i = 0; i < lines.length; i += 4) {
        const homeTeam = lines[i]?.trim();
        const homeScore = parseInt(lines[i + 1]);
        const awayScore = parseInt(lines[i + 2]);
        const awayTeam = lines[i + 3]?.trim();
        if (homeTeam && awayTeam && !isNaN(homeScore) && !isNaN(awayScore)) {
          parsed.push({ 
            homeTeam, 
            homeScore, 
            awayScore, 
            awayTeam,
            date: new Date().toISOString()
          });
        }
      }
      return parsed;
    }

    function saveMatches(matches) {
      const existing = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
      const stringified = m => `${m.homeTeam}-${m.homeScore}-${m.awayScore}-${m.awayTeam}`;
      const existingSet = new Set(existing.map(stringified));
      const newMatches = matches.filter(m => !existingSet.has(stringified(m)));
      const combined = [...existing, ...newMatches];
      localStorage.setItem(STORAGE_KEY, JSON.stringify(combined));
      updateEloRatings(newMatches);
      return newMatches.length;
    }

    function updateEloRatings(matches) {
      const K = 32;
      matches.forEach(match => {
        const { homeTeam, awayTeam, homeScore, awayScore } = match;
        if (!eloRatings[homeTeam]) eloRatings[homeTeam] = 1500;
        if (!eloRatings[awayTeam]) eloRatings[awayTeam] = 1500;

        const expectedHome = 1 / (1 + Math.pow(10, (eloRatings[awayTeam] - eloRatings[homeTeam]) / 400));
        const outcome = homeScore > awayScore ? 1 : homeScore === awayScore ? 0.5 : 0;

        eloRatings[homeTeam] += K * (outcome - expectedHome);
        eloRatings[awayTeam] += K * ((1 - outcome) - (1 - expectedHome));
      });
      localStorage.setItem(ELO_KEY, JSON.stringify(eloRatings));
    }
    function lastShockIndex(team, matches) {
  const teamGames = matches
    .filter(m => m.homeTeam === team || m.awayTeam === team)
    .reverse();

  for (let i = 0; i < teamGames.length; i++) {
    if (isShocking(teamGames[i])) return i;
  }
  return teamGames.length; // no shock in history
}

    function loadMatches() {
      return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    }
    function isShocking(match) {
  const totalGoals = match.homeScore + match.awayScore;
  const goalDiff = Math.abs(match.homeScore - match.awayScore);
  return totalGoals >= 5 || goalDiff >= 3;
}
function shockGap(matches) {
  const reversed = [...matches].reverse();
  for (let i = 0; i < reversed.length; i++) {
    if (isShocking(reversed[i])) return i;
  }
  return matches.length;
}

    function factorial(n) {
      return n <= 1 ? 1 : n * factorial(n - 1);
    }

    function predictScoreline(team1, team2, matches, shouldTriggerShock)  {
      const team1Stats = analyzeTeam(team1, matches);
      const team2Stats = analyzeTeam(team2, matches);

      const team1Attack = parseFloat(team1Stats.fullStrength.avgScore);
      const team2Attack = parseFloat(team2Stats.fullStrength.avgScore);
      const team1Defense = parseFloat(team1Stats.fullStrength.avgConcede);
      const team2Defense = parseFloat(team2Stats.fullStrength.avgConcede);

      const lambda1 = (team1Attack + team2Defense) / 2;
      const lambda2 = (team2Attack + team1Defense) / 2;

      const poisson = (lambda, k) => 
        (Math.exp(-lambda) * Math.pow(lambda, k)) / factorial(k);

      let scoreProbabilities = {};
      for (let i = 0; i <= 3; i++) {
        for (let j = 0; j <= 3; j++) {
          scoreProbabilities[`${i}-${j}`] = poisson(lambda1, i) * poisson(lambda2, j);
        }
      }
      if (shouldTriggerShock) {
  const shockScores = ["4-2", "3-3", "5-1", "1-5", "2-4", "1-4"];
  shockScores.forEach(s => {
    if (!scoreProbabilities[s]) {
      scoreProbabilities[s] = 0.05 + Math.random() * 0.03;
    }
  });
}

      return Object.entries(scoreProbabilities)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);
    }

    function analyzeTeam(team, matches) {
      const allGames = matches.filter(m => m.homeTeam === team || m.awayTeam === team);
      const homeGames = allGames.filter(m => m.homeTeam === team);
      const awayGames = allGames.filter(m => m.awayTeam === team);
      const recent = allGames.slice(-6).reverse();

      let w = 0, d = 0, l = 0, gs = 0, gc = 0, bts = 0, o15 = 0, o25 = 0, o35 = 0;
      const details = recent.map(m => {
        const isHome = m.homeTeam === team;
        const scored = isHome ? m.homeScore : m.awayScore;
        const conceded = isHome ? m.awayScore : m.homeScore;
        const total = m.homeScore + m.awayScore;
        
        gs += scored;
        gc += conceded;
        if (scored > conceded) w++;
        else if (scored < conceded) l++;
        else d++;
        
        if (m.homeScore > 0 && m.awayScore > 0) bts++;
        if (total > 1.5) o15++;
        if (total > 2.5) o25++;
        if (total > 3.5) o35++;
        
        return `${m.homeTeam} ${m.homeScore}-${m.awayScore} ${m.awayTeam}`;
      });

      const calculateStats = (games, isHome) => {
        let stats = { w: 0, d: 0, l: 0, gs: 0, gc: 0 };
        games.forEach(m => {
          const scored = isHome ? m.homeScore : m.awayScore;
          const conceded = isHome ? m.awayScore : m.homeScore;
          stats.gs += scored;
          stats.gc += conceded;
          if (scored > conceded) stats.w++;
          else if (scored < conceded) stats.l++;
          else stats.d++;
        });
        return stats;
      };

      const homeStats = calculateStats(homeGames, true);
      const awayStats = calculateStats(awayGames, false);

      const totalGames = allGames.length;
      const fullStrength = {
        avgScore: totalGames > 0 ? (allGames.reduce((sum, m) => sum + (m.homeTeam === team ? m.homeScore : m.awayScore), 0) / totalGames).toFixed(2) : 0,
        avgConcede: totalGames > 0 ? (allGames.reduce((sum, m) => sum + (m.homeTeam === team ? m.awayScore : m.homeScore), 0) / totalGames).toFixed(2) : 0
      };

      const streakInfo = detectStreaks(team, matches);

      return {
        form: details,
        summary: `W${w} D${d} L${l}`,
        gs, gc, bts, o15, o25, o35,
        homeStats, awayStats, fullStrength,
        streak: streakInfo.streak,
        lastSequence: streakInfo.sequence
      };
    }

    function detectStreaks(team, matches) {
      const recent = matches
        .filter(m => m.homeTeam === team || m.awayTeam === team)
        .slice(-10)
        .map(m => {
          const isWin = (m.homeTeam === team && m.homeScore > m.awayScore) || 
                       (m.awayTeam === team && m.awayScore > m.homeScore);
          return isWin ? 'W' : (m.homeScore === m.awayScore ? 'D' : 'L');
        });

      if (recent.length === 0) return { streak: "N/A", sequence: "" };

      let currentStreak = 1;
      let streakType = recent[0];
      for (let i = 1; i < recent.length; i++) {
        if (recent[i] === streakType) currentStreak++;
        else break;
      }

      return { streak: `${streakType}${currentStreak}`, sequence: recent.join('') };
    }

    function estimateXG(team, matches) {
      const recent = matches
        .filter(m => m.homeTeam === team || m.awayTeam === team)
        .slice(-5);

      if (recent.length === 0) return 0;

      const totalGoals = recent.reduce((sum, m) => sum + 
        (m.homeTeam === team ? m.homeScore : m.awayScore), 0);
      
      const totalShots = recent.length * 10; // Simplified assumption
      const conversionRate = totalGoals / totalShots;
      
      return (conversionRate * 10).toFixed(2);
    }

    function findSafeMatches() {
  const matches = loadMatches();
  const safeMatches = [];
  const allTeams = [...new Set(matches.flatMap(m => [m.homeTeam, m.awayTeam]))];

  allTeams.forEach(team => {
    const teamMatches = matches
      .filter(m => m.homeTeam === team || m.awayTeam === team)
      .sort((a, b) => new Date(b.date) - new Date(a.date));

    if (teamMatches.length < 5) return; // skip teams with fewer than 5 matches

    const recentMatches = teamMatches.slice(0, 5); // or use 6 for last 6 matches
    const scored = recentMatches.map(m => (m.homeTeam === team ? m.homeScore : m.awayScore));
    const conceded = recentMatches.map(m => (m.homeTeam === team ? m.awayScore : m.homeScore));
    const results = recentMatches.map((m, i) => {
      const s = scored[i], c = conceded[i];
      return s > c ? 'W' : s < c ? 'L' : 'D';
    });

    const totalGoals = recentMatches.map((m) => m.homeScore + m.awayScore);

    const patterns = [];

    if (recentMatches.every(m => m.homeScore > 0 && m.awayScore > 0)) patterns.push("BTTS Yes");
    if (totalGoals.every(t => t > 2.5)) patterns.push("Over 2.5 Goals");
    if (totalGoals.every(t => t > 3.5)) patterns.push("Over 3.5 Goals");
    if (totalGoals.every(t => t < 2.5)) patterns.push("Under 2.5 Goals");
    if (scored.every(g => g > 0)) patterns.push("Scoring Streak");
    if (scored.every(g => g === 0)) patterns.push("Fail to Score");
    if (conceded.every(g => g === 0)) patterns.push("Clean Sheets");
    if (results.every(r => r === 'W')) patterns.push("Winning Streak");
    if (results.every(r => r === 'L')) patterns.push("Losing Streak");
    if (results.every(r => r === 'D')) patterns.push("Draw Streak");

    patterns.forEach(pat => {
      safeMatches.push({
        team,
        pattern: pat,
        matches: recentMatches
      });
    });
  });

  return safeMatches;
}

    function displaySafeMatches() {
  const matches = loadMatches();
  const safeMatches = [];
  const allTeams = [...new Set(matches.flatMap(m => [m.homeTeam, m.awayTeam]))];

  allTeams.forEach(team => {
    const teamMatches = matches
      .filter(m => m.homeTeam === team || m.awayTeam === team)
      .sort((a, b) => new Date(b.date) - new Date(a.date));

    if (teamMatches.length < 5) return;

    const recentMatches = teamMatches.slice(0, 5);
    const scored = recentMatches.map(m => (m.homeTeam === team ? m.homeScore : m.awayScore));
    const conceded = recentMatches.map(m => (m.homeTeam === team ? m.awayScore : m.homeScore));
    const results = recentMatches.map((m, i) => {
      const s = scored[i], c = conceded[i];
      return s > c ? 'W' : s < c ? 'L' : 'D';
    });

    const totalGoals = recentMatches.map(m => m.homeScore + m.awayScore);

    const patterns = [];

    if (recentMatches.every(m => m.homeScore > 0 && m.awayScore > 0)) patterns.push("💣 BTTS Yes");
    if (totalGoals.every(t => t > 2.5)) patterns.push("🔥 Over 2.5 Goals");
    if (totalGoals.every(t => t > 3.5)) patterns.push("🚀 Over 3.5 Goals");
    if (totalGoals.every(t => t < 2.5)) patterns.push("⚽ Under 2.5 Goals");
    if (scored.every(g => g > 0)) patterns.push("🎯 Scoring Streak");
    if (scored.every(g => g === 0)) patterns.push("🚫 Fail to Score");
    if (conceded.every(g => g === 0)) patterns.push("🧤 Clean Sheets");
    if (results.every(r => r === 'W')) patterns.push("🏆 Winning Streak");
    if (results.every(r => r === 'L')) patterns.push("🔻 Losing Streak");
    if (results.every(r => r === 'D')) patterns.push("⚖️ Draw Streak");

    const shockGap = lastShockIndex(team, teamMatches);
    const losingStreak = results.every(r => r === 'L');
    const winningStreak = results.every(r => r === 'W');

    const note = shockGap <= 1
      ? "⚠️ Pattern just broken – expect changes"
      : losingStreak
      ? "🔁 Lost 5 games – potential rebound soon"
      : shockGap < 3
      ? "🟡 Trend may shift – recent volatility"
      : "✅ Strong trend detected";

    const predictFutureMessage = (results, pattern, shockGap) => {
      const losses = results.filter(r => r === 'L').length;
      const wins = results.filter(r => r === 'W').length;

      if (shockGap <= 1) {
        return "🔮 Pattern broken – future results may be volatile.";
      }
      if (pattern.includes("Under 2.5") && shockGap > 2) {
        return "🔮 Trend may continue as low-scoring unless a shock occurs.";
      }
      if (losses >= 5) {
        return "🔮 Losing streak detected – draw or win possible next.";
      }
      if (wins >= 5) {
        return "🔮 Winning trend strong – draw/loss risk increases.";
      }
      if (pattern.includes("BTTS")) {
        return "🔮 Expect both teams to score again unless trend breaks.";
      }
      return "🔄 Future result uncertain – monitor next match closely.";
    };

    const forecastNextPossibility = (pattern, recentMatches, results) => {
      const lastMatch = recentMatches[0];
      const totalGoals = lastMatch.homeScore + lastMatch.awayScore;
      const btts = lastMatch.homeScore > 0 && lastMatch.awayScore > 0;
      const lastResult = results[0];

      if (pattern.includes("Under 2.5") && totalGoals >= 3) {
        return "📈 Possibility: Over 2.5 Goals in next 2–3 games";
      }
      if (pattern.includes("Over 2.5") && totalGoals < 2) {
        return "📉 Possibility: Under 2.5 Goals might return soon";
      }
      if (pattern.includes("BTTS") && !btts) {
        return "📉 Possibility: One-sided scores likely next";
      }
      if (pattern.includes("Fail to Score") && totalGoals > 0) {
        return "📈 Possibility: Team may start scoring regularly";
      }
      if (pattern.includes("Winning") && lastResult === 'L') {
        return "🔁 Possibility: Draw or another loss next";
      }
      if (pattern.includes("Losing") && lastResult === 'W') {
        return "📈 Possibility: Winning form may begin";
      }
      return "🔄 Pattern may continue or shift depending on opponent";
    };

    patterns.forEach(pat => {
      safeMatches.push({
        team,
        pattern: pat,
        matches: recentMatches,
        note,
        predictionNote: predictFutureMessage(results, pat, shockGap),
        possibilityForecast: forecastNextPossibility(pat, recentMatches, results)
      });
    });
  });

  const out = document.getElementById('safeMatchesOutput');

  if (safeMatches.length === 0) {
    out.innerHTML = "<div class='safe-match'>No safe matches found with consistent patterns.</div>";
    return;
  }

  let output = "<h3 class='result-title'><i class='fas fa-shield-alt'></i> Safe Matches Found</h3>";

  safeMatches.forEach(item => {
    const noteColor = item.note.includes("⚠️") ? "#e53935"
      : item.note.includes("🔁") ? "#fb8c00"
      : item.note.includes("🟡") ? "#fbc02d"
      : "#4caf50";

    output += `<div class='safe-match'>
      <strong>${item.team}</strong>
      <span class='pattern-badge' title="Pattern from last 5 games">${item.pattern}</span>
      <div class='match-detail'>`;

    item.matches.forEach(m => {
      output += `<div>${m.homeTeam} ${m.homeScore}-${m.awayScore} ${m.awayTeam}</div>`;
    });

    output += `</div>
      <div style="margin-top: 10px; font-style: italic; color: ${noteColor};">
        ${item.note}
      </div>
      <div style="color:#6a1b9a; margin-top: 5px;">
        ${item.predictionNote}
      </div>
      <div style="color:#00796b; margin-top: 5px;">
        ${item.possibilityForecast}
      </div>
    </div>`;
  });

  out.innerHTML = output;
}

    function clearStorage() {
      if (confirm('Clear all saved data?')) {
        localStorage.removeItem(STORAGE_KEY);
        localStorage.removeItem(ELO_KEY);
        eloRatings = {};
        loadTeams();
        document.getElementById('output').innerText = 'All data cleared.';
        showMatchCount();
        document.getElementById('safeMatchesOutput').innerHTML = '';
      }
    }

    function loadTeams() {
      const matches = loadMatches();
      const teams = Array.from(new Set(matches.flatMap(m => [m.homeTeam.trim(), m.awayTeam.trim()])))
        .map(t => t.trim())
        .sort();
      
      ['team1', 'team2'].forEach(id => {
        const sel = document.getElementById(id);
        sel.innerHTML = '<option value="">Select Team</option>';
        teams.forEach(team => sel.innerHTML += `<option value="${team}">${team}</option>`);
      });
    }

    function showMatchCount() {
      const count = loadMatches().length;
      document.getElementById('matchCount').innerText = count;
    }

    function downloadData() {
      const data = localStorage.getItem(STORAGE_KEY);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'match_data.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    function uploadData(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const uploaded = JSON.parse(e.target.result);
          const addedCount = saveMatches(uploaded);
          loadTeams();
          alert(`Uploaded ${addedCount} matches.`);
          showMatchCount();
        } catch (err) {
          alert("Invalid file format.");
        }
      };
      reader.readAsText(file);
    }

    function showSmartPrediction() {
  const t1 = document.getElementById('team1').value;
  const t2 = document.getElementById('team2').value;
  
  const matches = loadMatches();
  const out = document.getElementById('output');

  const team1ShockGap = lastShockIndex(t1, matches);
  const team2ShockGap = lastShockIndex(t2, matches);
  const avgShockGap = (team1ShockGap + team2ShockGap) / 2;

  const shouldTriggerShock = avgShockGap >= 5; // Custom threshold

  if (!t1 || !t2 || t1 === t2) {
    out.innerHTML = '<div class="prediction-section">Please select two different teams.</div>';
    return;
  }

  // ... rest of the function continues as is ...

      // Head-to-head
      const h2h = matches.filter(m => 
        [m.homeTeam, m.awayTeam].includes(t1) && 
        [m.homeTeam, m.awayTeam].includes(t2)
      );

      // Team analyses
      const t1Stats = analyzeTeam(t1, matches);
      const t2Stats = analyzeTeam(t2, matches);

      // Elo calculations
      if (!eloRatings[t1]) eloRatings[t1] = 1500;
      if (!eloRatings[t2]) eloRatings[t2] = 1500;
      const eloDifference = eloRatings[t1] - eloRatings[t2];
      const eloWinProbability = 1 / (1 + Math.pow(10, -eloDifference / 400));

      // Scoreline prediction
      const likelyScores = predictScoreline(t1, t2, matches, shouldTriggerShock);

      // Expected goals
      const t1xG = estimateXG(t1, matches);
      const t2xG = estimateXG(t2, matches);
      const totalxG = (parseFloat(t1xG) + parseFloat(t2xG)).toFixed(2);

      // Draw probability
      const historicalDraws = matches.filter(m => 
        (m.homeTeam === t1 && m.awayTeam === t2) || 
        (m.homeTeam === t2 && m.awayTeam === t1)
      ).filter(m => m.homeScore === m.awayScore).length;
      const totalMeetings = h2h.length || 1;
      const drawProbability = Math.round((historicalDraws / totalMeetings) * 100);

      // Generate market predictions
      const markets = {
        winner: {
          team1: Math.round(eloWinProbability * 100) + "%",
          team2: Math.round((1 - eloWinProbability) * 100 - drawProbability) + "%",
          draw: drawProbability + "%"
        },
        gg: {
          prediction: t1Stats.bts + t2Stats.bts >= 5 ? "YES" : "NO",
          confidence: t1Stats.bts + t2Stats.bts >= 7 ? "HIGH" : 
                     t1Stats.bts + t2Stats.bts >= 4 ? "MEDIUM" : "LOW"
        },
        overUnders: {
          "1.5": t1Stats.o15 + t2Stats.o15 >= 10 ? "VERY LIKELY" :
                 t1Stats.o15 + t2Stats.o15 >= 7 ? "LIKELY" : "RISKY",
          "2.5": t1Stats.o25 + t2Stats.o25 >= 8 ? "VERY LIKELY" :
                 t1Stats.o25 + t2Stats.o25 >= 5 ? "LIKELY" : "RISKY",
          "3.5": t1Stats.o35 + t2Stats.o35 >= 6 ? "LIKELY" :
                 t1Stats.o35 + t2Stats.o35 >= 3 ? "POSSIBLE" : "UNLIKELY"
        },
        doubleChance: {
          "1X": eloWinProbability > 0.6 ? "SAFE" : "MODERATE",
          "X2": eloWinProbability < 0.4 ? "SAFE" : "MODERATE",
          "12": "VERY SAFE"
        },
        goalRanges: {
          "0-1": likelyScores.filter(s => {
            const goals = parseInt(s[0].split('-')[0]) + parseInt(s[0].split('-')[1]);
            return goals <= 1;
          }).reduce((sum, s) => sum + s[1], 0) > 0.3 ? "POSSIBLE" : "UNLIKELY",
          "2-3": likelyScores.filter(s => {
            const goals = parseInt(s[0].split('-')[0]) + parseInt(s[0].split('-')[1]);
            return goals >= 2 && goals <= 3;
          }).reduce((sum, s) => sum + s[1], 0) > 0.5 ? "LIKELY" : "POSSIBLE",
          "4+": likelyScores.filter(s => {
            const goals = parseInt(s[0].split('-')[0]) + parseInt(s[0].split('-')[1]);
            return goals >= 4;
          }).reduce((sum, s) => sum + s[1], 0) > 0.2 ? "POSSIBLE" : "UNLIKELY"
        }
      };

      // Generate output
      let output = `<div class="prediction-section">
        <h4 class="prediction-header"><i class="fas fa-history"></i> HEAD-TO-HEAD (Last ${h2h.length} meetings)</h4>
        <div class="match-detail">`;
      output += h2h.map(m => `${m.homeTeam} ${m.homeScore}-${m.awayScore} ${m.awayTeam}`).join('<br>') || 'No past meetings';
      output += '</div></div>';
      
      output += `<div class="prediction-section">
        <h4 class="prediction-header"><i class="fas fa-chart-line"></i> ${t1} ANALYSIS</h4>
        <div class="match-detail">`;
      output += `${t1Stats.form.join('<br>')}<br><br>
        🏠 Home: W${t1Stats.homeStats.w} D${t1Stats.homeStats.d} L${t1Stats.homeStats.l}<br>
        ✈️ Away: W${t1Stats.awayStats.w} D${t1Stats.awayStats.d} L${t1Stats.awayStats.l}<br>
        🔥 Form: ${t1Stats.streak} (Last 10: ${t1Stats.lastSequence})`;
      output += '</div></div>';
      
      output += `<div class="prediction-section">
        <h4 class="prediction-header"><i class="fas fa-chart-line"></i> ${t2} ANALYSIS</h4>
        <div class="match-detail">`;
      output += `${t2Stats.form.join('<br>')}<br><br>
        🏠 Home: W${t2Stats.homeStats.w} D${t2Stats.homeStats.d} L${t2Stats.homeStats.l}<br>
        ✈️ Away: W${t2Stats.awayStats.w} D${t2Stats.awayStats.d} L${t2Stats.awayStats.l}<br>
        🔥 Form: ${t2Stats.streak} (Last 10: ${t2Stats.lastSequence})`;
      output += '</div></div>';

      // Betting markets section
      output += '<div class="prediction-section">';
      output += '<h4 class="prediction-header"><i class="fas fa-trophy"></i> BETTING MARKET PREDICTIONS</h4>';
      
      output += '<div class="prediction-grid">';
      
      output += `<div class="prediction-card">
          <h5 class="card-title"><i class="fas fa-trophy"></i> Match Winner</h5>
          <div class="prediction-item">
            <span>${t1}:</span>
            <span class="confidence">${markets.winner.team1}</span>
          </div>
          <div class="prediction-item">
            <span>${t2}:</span>
            <span class="confidence">${markets.winner.team2}</span>
          </div>
          <div class="prediction-item">
            <span>Draw:</span>
            <span class="confidence">${markets.winner.draw}</span>
          </div>
        </div>`;
      
      output += `<div class="prediction-card">
          <h5 class="card-title"><i class="fas fa-futbol"></i> Both Teams to Score</h5>
          <div class="prediction-item">
            <span>Prediction:</span>
            <span class="confidence">${markets.gg.prediction}</span>
          </div>
          <div class="prediction-item">
            <span>Confidence:</span>
            <span class="confidence">${markets.gg.confidence}</span>
          </div>
        </div>`;
      
      output += `<div class="prediction-card">
          <h5 class="card-title"><i class="fas fa-signal"></i> Over/Under Goals</h5>
          <div class="prediction-item">
            <span>Over 1.5:</span>
            <span class="confidence">${markets.overUnders["1.5"]}</span>
          </div>
          <div class="prediction-item">
            <span>Over 2.5:</span>
            <span class="confidence">${markets.overUnders["2.5"]}</span>
          </div>
          <div class="prediction-item">
            <span>Over 3.5:</span>
            <span class="confidence">${markets.overUnders["3.5"]}</span>
          </div>
        </div>`;
      
      output += '</div></div>'; // Close prediction-grid and prediction-section

      // Scoreline predictions
      output += `<div class="prediction-section">
        <h4 class="prediction-header"><i class="fas fa-star"></i> TOP PREDICTED SCORELINES</h4>
        <div class="match-detail">`;
      likelyScores.forEach(([score, prob]) => {
        output += `<div>${score}: ${(prob * 100).toFixed(1)}% chance</div>`;
      });
      output += '</div></div>';

      // Final recommendation
      output += `<div class="recommendation">
        <h5 class="recommendation-title"><i class="fas fa-gem"></i> RECOMMENDED BETS</h5>
        <ul class="recommendation-list">`;
      
      if (markets.overUnders["1.5"].includes("VERY LIKELY")) {
        output += '<li><strong>Over 1.5 Goals</strong> - Very likely outcome</li>';
      }
      if (markets.gg.prediction === "YES" && markets.gg.confidence === "HIGH") {
        output += '<li><strong>Both Teams to Score (YES)</strong> - High confidence</li>';
      }
      if (markets.doubleChance["1X"] === "SAFE" && eloWinProbability > 0.65) {
        output += `<li><strong>${t1} or Draw</strong> - Safe bet</li>`;
      }
      if (markets.goalRanges["2-3"] === "LIKELY") {
        output += '<li><strong>Total Goals 2-3</strong> - Good value</li>';
      }
      
      if (!output.includes('<li>')) {
        output += '<li>No strong recommendations based on current data</li>';
      }
      
      output += '</ul></div>';

      out.innerHTML = output;
    }
  </script>
</body>
</html>